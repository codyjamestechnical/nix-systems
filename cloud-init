#cloud-config
write_files:
    - path: /etc/nixos/host.nix
      permissions: '0644'
      content: |
        { config, pkgs, ... }: 
        {
            nix.settings.experimental-features = [ "nix-command" "flakes" ];
            programs.git.enable = true;
            programs.zsh = {
                enable = true;
                enableBashCompletion = true;
                histSize = 10000;

                autosuggestions.enable = true;
                shellAliases = {
                    rebuild = "cd /etc/nixos/nix-systems && sudo git pull && sudo nixos-rebuild switch --flake '.#${config.networking.hostName}'";
                
                };
            };
        }

    - path: /etc/nixos/secrets/cloudflare-token
      permissions: '0640'
      content: |
        CLOUDFLARE_DNS_API_TOKEN=YOUR_CLOUDFLARE_API_TOKEN_HERE

    - path: /etc/nixos/secrets/komodo-passkey
      permissions: '0640'
      content: |
        YOUR_KOMODO_PASSKEY_HERE

    - path: /etc/nixos/secrets/tailscale_key
      permissions: '0640'
      content: |
        YOUR_TAILSCALE_KEY_HERE

    - path: /etc/nixos/secrets/beszel-agent.env
      permissions: '0640'
      content: |
        LISTEN=45876
        KEY=
        TOKEN=
        HUB_URL=https://beszel.31337.im

    - path: /etc/nixos/secrets/cody_password
      permissions: '0640'
      content: |
        USER_HASHED_PASSWORD_HERE # Replace with actual hashed password using `mkpasswd`

runcmd:
    - git clone https://github.com/codyjamestechnical/nix-systems.git /etc/nixos/nix-systems
    - mkdir /etc/nixos/secrets
    - chown root:root -R /etc/nixos/secrets
    - chmod 640 -R /etc/nixos/secrets
    - cp /var/log/cloud-init-output.log /root/.
    - curl https://raw.githubusercontent.com/elitak/nixos-infect/master/nixos-infect | PROVIDER=hetznercloud NIXOS_IMPORT=./host.nix NIX_CHANNEL=nixos-25.11 NO_REBOOT=true bash 2>&1 | tee /tmp/infect.log
    - reboot
    # - nixos-rebuild switch --flake "/etc/nixos/nix-systems#$(hostname)"
    # - reboot